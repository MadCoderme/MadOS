#include "IST.h"
#include "IDT.h"
#include "../userinput/keyboard.h"
#include "../BasicRenderer.h"
#include "../cstr.h"

void InstallISR() {
  IdtSetEntry(0, (uint64_t)isr0);
  IdtSetEntry(1, (uint64_t)isr1);
  IdtSetEntry(2, (uint64_t)isr2);
  IdtSetEntry(3, (uint64_t)isr3);
  IdtSetEntry(4, (uint64_t)isr4);
  IdtSetEntry(5, (uint64_t)isr5);
  IdtSetEntry(6, (uint64_t)isr6);
  IdtSetEntry(7, (uint64_t)isr7);
  IdtSetEntry(8, (uint64_t)errorIsr8);
  IdtSetEntry(9, (uint64_t)isr9);
  IdtSetEntry(10, (uint64_t)errorIsr10);
  IdtSetEntry(11, (uint64_t)errorIsr11);
  IdtSetEntry(12, (uint64_t)errorIsr12);
  IdtSetEntry(13, (uint64_t)errorIsr13);
  IdtSetEntry(14, (uint64_t)errorIsr14);
  IdtSetEntry(15, (uint64_t)isr15);
  IdtSetEntry(16, (uint64_t)isr16);
  IdtSetEntry(17, (uint64_t)isr17);
  IdtSetEntry(18, (uint64_t)isr18);
  IdtSetEntry(19, (uint64_t)isr19);
  IdtSetEntry(20, (uint64_t)isr20);
  IdtSetEntry(21, (uint64_t)isr21);
  IdtSetEntry(22, (uint64_t)isr22);
  IdtSetEntry(23, (uint64_t)isr23);
  IdtSetEntry(24, (uint64_t)isr24);
  IdtSetEntry(25, (uint64_t)isr25);
  IdtSetEntry(26, (uint64_t)isr26);
  IdtSetEntry(27, (uint64_t)isr27);
  IdtSetEntry(28, (uint64_t)isr28);
  IdtSetEntry(29, (uint64_t)isr29);
  IdtSetEntry(30, (uint64_t)isr30);
  IdtSetEntry(31, (uint64_t)isr31);

  RemapPIC();

  IdtSetEntry(32, (uint64_t)isr32);
  IdtSetEntry(33, (uint64_t)isr33);
  IdtSetEntry(34, (uint64_t)isr34);
  IdtSetEntry(35, (uint64_t)isr35);
  IdtSetEntry(36, (uint64_t)isr36);
  IdtSetEntry(37, (uint64_t)isr37);
  IdtSetEntry(38, (uint64_t)isr38);
  IdtSetEntry(39, (uint64_t)isr39);
  IdtSetEntry(40, (uint64_t)isr40);
  IdtSetEntry(41, (uint64_t)isr41);
  IdtSetEntry(42, (uint64_t)isr42);
  IdtSetEntry(43, (uint64_t)isr43);
  IdtSetEntry(44, (uint64_t)isr44);
  IdtSetEntry(45, (uint64_t)isr45);
  IdtSetEntry(46, (uint64_t)isr46);
  IdtSetEntry(47, (uint64_t)isr47);
  IdtSetEntry(48, (uint64_t)isr48);
  IdtSetEntry(49, (uint64_t)isr49);
  IdtSetEntry(50, (uint64_t)isr50);
  IdtSetEntry(51, (uint64_t)isr51);
  IdtSetEntry(52, (uint64_t)isr52);
  IdtSetEntry(53, (uint64_t)isr53);
  IdtSetEntry(54, (uint64_t)isr54);
  IdtSetEntry(55, (uint64_t)isr55);
  IdtSetEntry(56, (uint64_t)isr56);
  IdtSetEntry(57, (uint64_t)isr57);
  IdtSetEntry(58, (uint64_t)isr58);
  IdtSetEntry(59, (uint64_t)isr59);
  IdtSetEntry(60, (uint64_t)isr60);
  IdtSetEntry(61, (uint64_t)isr61);
  IdtSetEntry(62, (uint64_t)isr62);
  IdtSetEntry(63, (uint64_t)isr63);
  IdtSetEntry(64, (uint64_t)isr64);
  IdtSetEntry(65, (uint64_t)isr65);
  IdtSetEntry(66, (uint64_t)isr66);
  IdtSetEntry(67, (uint64_t)isr67);
  IdtSetEntry(68, (uint64_t)isr68);
  IdtSetEntry(69, (uint64_t)isr69);
  IdtSetEntry(70, (uint64_t)isr70);
  IdtSetEntry(71, (uint64_t)isr71);
  IdtSetEntry(72, (uint64_t)isr72);
  IdtSetEntry(73, (uint64_t)isr73);
  IdtSetEntry(74, (uint64_t)isr74);
  IdtSetEntry(75, (uint64_t)isr75);
  IdtSetEntry(76, (uint64_t)isr76);
  IdtSetEntry(77, (uint64_t)isr77);
  IdtSetEntry(78, (uint64_t)isr78);
  IdtSetEntry(79, (uint64_t)isr79);
  IdtSetEntry(80, (uint64_t)isr80);
  IdtSetEntry(81, (uint64_t)isr81);
  IdtSetEntry(82, (uint64_t)isr82);
  IdtSetEntry(83, (uint64_t)isr83);
  IdtSetEntry(84, (uint64_t)isr84);
  IdtSetEntry(85, (uint64_t)isr85);
  IdtSetEntry(86, (uint64_t)isr86);
  IdtSetEntry(87, (uint64_t)isr87);
  IdtSetEntry(88, (uint64_t)isr88);
  IdtSetEntry(89, (uint64_t)isr89);
  IdtSetEntry(90, (uint64_t)isr90);
  IdtSetEntry(91, (uint64_t)isr91);
  IdtSetEntry(92, (uint64_t)isr92);
  IdtSetEntry(93, (uint64_t)isr93);
  IdtSetEntry(94, (uint64_t)isr94);
  IdtSetEntry(95, (uint64_t)isr95);
  IdtSetEntry(96, (uint64_t)isr96);
  IdtSetEntry(97, (uint64_t)isr97);
  IdtSetEntry(98, (uint64_t)isr98);
  IdtSetEntry(99, (uint64_t)isr99);
  IdtSetEntry(100, (uint64_t)isr100);
  IdtSetEntry(101, (uint64_t)isr101);
  IdtSetEntry(102, (uint64_t)isr102);
  IdtSetEntry(103, (uint64_t)isr103);
  IdtSetEntry(104, (uint64_t)isr104);
  IdtSetEntry(105, (uint64_t)isr105);
  IdtSetEntry(106, (uint64_t)isr106);
  IdtSetEntry(107, (uint64_t)isr107);
  IdtSetEntry(108, (uint64_t)isr108);
  IdtSetEntry(109, (uint64_t)isr109);
  IdtSetEntry(110, (uint64_t)isr110);
  IdtSetEntry(111, (uint64_t)isr111);
  IdtSetEntry(112, (uint64_t)isr112);
  IdtSetEntry(113, (uint64_t)isr113);
  IdtSetEntry(114, (uint64_t)isr114);
  IdtSetEntry(115, (uint64_t)isr115);
  IdtSetEntry(116, (uint64_t)isr116);
  IdtSetEntry(117, (uint64_t)isr117);
  IdtSetEntry(118, (uint64_t)isr118);
  IdtSetEntry(119, (uint64_t)isr119);
  IdtSetEntry(120, (uint64_t)isr120);
  IdtSetEntry(121, (uint64_t)isr121);
  IdtSetEntry(122, (uint64_t)isr122);
  IdtSetEntry(123, (uint64_t)isr123);
  IdtSetEntry(124, (uint64_t)isr124);
  IdtSetEntry(125, (uint64_t)isr125);
  IdtSetEntry(126, (uint64_t)isr126);
  IdtSetEntry(127, (uint64_t)isr127);
  IdtSetEntry(128, (uint64_t)isr128);
  IdtSetEntry(129, (uint64_t)isr129);
  IdtSetEntry(130, (uint64_t)isr130);
  IdtSetEntry(131, (uint64_t)isr131);
  IdtSetEntry(132, (uint64_t)isr132);
  IdtSetEntry(133, (uint64_t)isr133);
  IdtSetEntry(134, (uint64_t)isr134);
  IdtSetEntry(135, (uint64_t)isr135);
  IdtSetEntry(136, (uint64_t)isr136);
  IdtSetEntry(137, (uint64_t)isr137);
  IdtSetEntry(138, (uint64_t)isr138);
  IdtSetEntry(139, (uint64_t)isr139);
  IdtSetEntry(140, (uint64_t)isr140);
  IdtSetEntry(141, (uint64_t)isr141);
  IdtSetEntry(142, (uint64_t)isr142);
  IdtSetEntry(143, (uint64_t)isr143);
  IdtSetEntry(144, (uint64_t)isr144);
  IdtSetEntry(145, (uint64_t)isr145);
  IdtSetEntry(146, (uint64_t)isr146);
  IdtSetEntry(147, (uint64_t)isr147);
  IdtSetEntry(148, (uint64_t)isr148);
  IdtSetEntry(149, (uint64_t)isr149);
  IdtSetEntry(150, (uint64_t)isr150);
  IdtSetEntry(151, (uint64_t)isr151);
  IdtSetEntry(152, (uint64_t)isr152);
  IdtSetEntry(153, (uint64_t)isr153);
  IdtSetEntry(154, (uint64_t)isr154);
  IdtSetEntry(155, (uint64_t)isr155);
  IdtSetEntry(156, (uint64_t)isr156);
  IdtSetEntry(157, (uint64_t)isr157);
  IdtSetEntry(158, (uint64_t)isr158);
  IdtSetEntry(159, (uint64_t)isr159);
  IdtSetEntry(160, (uint64_t)isr160);
  IdtSetEntry(161, (uint64_t)isr161);
  IdtSetEntry(162, (uint64_t)isr162);
  IdtSetEntry(163, (uint64_t)isr163);
  IdtSetEntry(164, (uint64_t)isr164);
  IdtSetEntry(165, (uint64_t)isr165);
  IdtSetEntry(166, (uint64_t)isr166);
  IdtSetEntry(167, (uint64_t)isr167);
  IdtSetEntry(168, (uint64_t)isr168);
  IdtSetEntry(169, (uint64_t)isr169);
  IdtSetEntry(170, (uint64_t)isr170);
  IdtSetEntry(171, (uint64_t)isr171);
  IdtSetEntry(172, (uint64_t)isr172);
  IdtSetEntry(173, (uint64_t)isr173);
  IdtSetEntry(174, (uint64_t)isr174);
  IdtSetEntry(175, (uint64_t)isr175);
  IdtSetEntry(176, (uint64_t)isr176);
  IdtSetEntry(177, (uint64_t)isr177);
  IdtSetEntry(178, (uint64_t)isr178);
  IdtSetEntry(179, (uint64_t)isr179);
  IdtSetEntry(180, (uint64_t)isr180);
  IdtSetEntry(181, (uint64_t)isr181);
  IdtSetEntry(182, (uint64_t)isr182);
  IdtSetEntry(183, (uint64_t)isr183);
  IdtSetEntry(184, (uint64_t)isr184);
  IdtSetEntry(185, (uint64_t)isr185);
  IdtSetEntry(186, (uint64_t)isr186);
  IdtSetEntry(187, (uint64_t)isr187);
  IdtSetEntry(188, (uint64_t)isr188);
  IdtSetEntry(189, (uint64_t)isr189);
  IdtSetEntry(190, (uint64_t)isr190);
  IdtSetEntry(191, (uint64_t)isr191);
  IdtSetEntry(192, (uint64_t)isr192);
  IdtSetEntry(193, (uint64_t)isr193);
  IdtSetEntry(194, (uint64_t)isr194);
  IdtSetEntry(195, (uint64_t)isr195);
  IdtSetEntry(196, (uint64_t)isr196);
  IdtSetEntry(197, (uint64_t)isr197);
  IdtSetEntry(198, (uint64_t)isr198);
  IdtSetEntry(199, (uint64_t)isr199);
  IdtSetEntry(200, (uint64_t)isr200);
  IdtSetEntry(201, (uint64_t)isr201);
  IdtSetEntry(202, (uint64_t)isr202);
  IdtSetEntry(203, (uint64_t)isr203);
  IdtSetEntry(204, (uint64_t)isr204);
  IdtSetEntry(205, (uint64_t)isr205);
  IdtSetEntry(206, (uint64_t)isr206);
  IdtSetEntry(207, (uint64_t)isr207);
  IdtSetEntry(208, (uint64_t)isr208);
  IdtSetEntry(209, (uint64_t)isr209);
  IdtSetEntry(210, (uint64_t)isr210);
  IdtSetEntry(211, (uint64_t)isr211);
  IdtSetEntry(212, (uint64_t)isr212);
  IdtSetEntry(213, (uint64_t)isr213);
  IdtSetEntry(214, (uint64_t)isr214);
  IdtSetEntry(215, (uint64_t)isr215);
  IdtSetEntry(216, (uint64_t)isr216);
  IdtSetEntry(217, (uint64_t)isr217);
  IdtSetEntry(218, (uint64_t)isr218);
  IdtSetEntry(219, (uint64_t)isr219);
  IdtSetEntry(220, (uint64_t)isr220);
  IdtSetEntry(221, (uint64_t)isr221);
  IdtSetEntry(222, (uint64_t)isr222);
  IdtSetEntry(223, (uint64_t)isr223);
  IdtSetEntry(224, (uint64_t)isr224);
  IdtSetEntry(225, (uint64_t)isr225);
  IdtSetEntry(226, (uint64_t)isr226);
  IdtSetEntry(227, (uint64_t)isr227);
  IdtSetEntry(228, (uint64_t)isr228);
  IdtSetEntry(229, (uint64_t)isr229);
  IdtSetEntry(230, (uint64_t)isr230);
  IdtSetEntry(231, (uint64_t)isr231);
  IdtSetEntry(232, (uint64_t)isr232);
  IdtSetEntry(233, (uint64_t)isr233);
  IdtSetEntry(234, (uint64_t)isr234);
  IdtSetEntry(235, (uint64_t)isr235);
  IdtSetEntry(236, (uint64_t)isr236);
  IdtSetEntry(237, (uint64_t)isr237);
  IdtSetEntry(238, (uint64_t)isr238);
  IdtSetEntry(239, (uint64_t)isr239);
  IdtSetEntry(240, (uint64_t)isr240);
  IdtSetEntry(241, (uint64_t)isr241);
  IdtSetEntry(242, (uint64_t)isr242);
  IdtSetEntry(243, (uint64_t)isr243);
  IdtSetEntry(244, (uint64_t)isr244);
  IdtSetEntry(245, (uint64_t)isr245);
  IdtSetEntry(246, (uint64_t)isr246);
  IdtSetEntry(247, (uint64_t)isr247);
  IdtSetEntry(248, (uint64_t)isr248);
  IdtSetEntry(249, (uint64_t)isr249);
  IdtSetEntry(250, (uint64_t)isr250);
  IdtSetEntry(251, (uint64_t)isr251);
  IdtSetEntry(252, (uint64_t)isr252);
  IdtSetEntry(253, (uint64_t)isr253);
  IdtSetEntry(254, (uint64_t)isr254);
  IdtSetEntry(255, (uint64_t)isr255);
}

// Messages for each interrupt
extern "C" void isr_handler(registers_t *r) {
     const char *desc = "Unknown";
    if (r->isrNumber < 32)
    {
        desc = s_exceptionDesc[r->isrNumber];

        GlobalRenderer->color = 0xff00ffff;
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("Exception: ");
        GlobalRenderer->Print(desc);
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rax=");
        GlobalRenderer->Print(to_string((int64_t)r->rax));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rbx=");
        GlobalRenderer->Print(to_string((int64_t)r->rbx));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rcx=");
        GlobalRenderer->Print(to_string((int64_t)r->rcx));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rdx=");
        GlobalRenderer->Print(to_string((int64_t)r->rdx));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rsi=");
        GlobalRenderer->Print(to_string((int64_t)r->rsi));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rdi=");
        GlobalRenderer->Print(to_string((int64_t)r->rdi));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rip=");
        GlobalRenderer->Print(to_string((int64_t)r->rip));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  rsp=");
        GlobalRenderer->Print(to_string((int64_t)r->rsp));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  cs=");
        GlobalRenderer->Print(to_string((int64_t)r->cs));
        GlobalRenderer->NextLine();
        GlobalRenderer->Print("  ss=");
        GlobalRenderer->Print(to_string((int64_t)r->ss));
        GlobalRenderer->NextLine();

        asm("hlt");
    }
    else 
    {
        if (r->isrNumber == 33)
        {
            HandleKeyboard();
        }

        outb(0xA0, 0x20);
        outb(0x20, 0x20);
    }
}